angular.module("yoodle",["ui.bootstrap","ngRoute","ngAnimate","picardy.fontawesome","toastr","LocalStorageModule"]).config(function($routeProvider,localStorageServiceProvider){$routeProvider.when("/app",{templateUrl:"templates/menu.html",controller:"AppCtrl"}).when("/play",{cache:!1,templateUrl:"templates/play.html",controller:"PlayCtrl"}).when("/end",{templateUrl:"templates/gallery.html",controller:"Gallery"}).otherwise({redirectTo:"/app"}),localStorageServiceProvider.setPrefix("yoodle")}).run(function(){}),angular.module("yoodle").factory("serverInterfaceService",function(){return{init:function($scope,$rootScope,$timeout,$interval,$location,toastr,localStorageService,roomService){$scope.connectionStatus={color:"yellow"};var ip=localStorageService.get("serverIP")||"127.0.0.1";$rootScope.socket=io("http://"+ip+":3001",{"connect timeout":5e3}),$rootScope.socket.on("connect",function(){console.log("Connected to server"),$timeout(function(){$scope.connectionStatus={color:"green"}}),$rootScope.socket.on("playersInsufficient",function(){console.log("Need at least 3 players to start."),toastr.warning("Need at least 3 players to start.")}),$rootScope.socket.on("roomCreated",function(roomID){console.log("New room created. ID: "+roomID),roomService.setRoomID(roomID),$rootScope.socket.emit("joinRoom",roomID,localStorageService.get("username"),localStorageService.get("difficulty"))}),$rootScope.socket.on("roomJoined",function(success,msg){success?$rootScope.$apply(function(){$location.path("play")}):(console.log("Failed to join. "+msg),toastr.error(msg,"Hmm... That didn't work"))}),$rootScope.socket.on("updatePlayerList",function(list){roomService.setPlayerList(list)}),$rootScope.socket.on("gameStarted",function(time){console.log("Game started!"),$rootScope.gameStarted=!0,roomService.newTimer(time)}),$rootScope.socket.on("artistSelected",function(name){$rootScope.isArtist=!1,$rootScope.artistName=name,name==localStorageService.get("username")?(console.log("I'm the artist!"),$rootScope.isArtist=!0,toastr.info("You are the artist now","Your turn")):toastr.info(name+" is the artist now"),$rootScope.clearCtx()})}),$rootScope.socket.on("minusTimer",function(){roomService.minusTimer(5),$rootScope.isArtist?toastr.warning("You skipped the word!","-5 seconds!"):toastr.warning("The artist skipped the word")}),$rootScope.socket.on("connect_error",function(err){console.log("error"),$timeout(function(){$scope.connectionStatus={color:"red"}})})}}}),angular.module("yoodle").controller("AppCtrl",function($scope,$rootScope,$location,$interval,$timeout,$uibModal,toastr,localStorageService,roomService,serverInterfaceService){$scope.createGame=function(){return $rootScope.socket.connected?void $rootScope.socket.emit("createRoom",localStorageService.get("difficulty")):void toastr.error("Unable to connect to the server.","Not connected")},$scope.joinGame=function(){return $rootScope.socket.connected?void($rootScope.modalInstance=$uibModal.open({animation:!0,templateUrl:"templates/joinRoomModal.html",controller:"JoinRoomModalCtrl"})):void toastr.error("Unable to connect to the server.","Not connected")},console.log(localStorageService.get("username")),localStorageService.get("username")?$scope.username=localStorageService.get("username"):($rootScope.modalInstance=$uibModal.open({animation:!0,templateUrl:"templates/settingsModal.html",controller:"SettingsModalCtrl",backdrop:"static",keyboard:!1}),$rootScope.modalInstance.closed.then(function(){$scope.username=localStorageService.get("username")})),$scope.openSettings=function(){$rootScope.modalInstance=$uibModal.open({animation:!0,templateUrl:"templates/settingsModal.html",controller:"SettingsModalCtrl"}),$rootScope.modalInstance.closed.then(function(){$scope.username=localStorageService.get("username"),$rootScope.socket.connected&&($rootScope.socket.disconnect(),$rootScope.socket=void 0),initServer()})};var initServer=function(){(void 0===$rootScope.socket||$rootScope.socket&&!$rootScope.socket.connected)&&serverInterfaceService.init($scope,$rootScope,$timeout,$interval,$location,toastr,localStorageService,roomService),$rootScope.socket&&$rootScope.socket.connected?$scope.connectionStatus={color:"green"}:$scope.connectionStatus={color:"red"}};initServer()}),angular.module("yoodle").controller("Gallery",function($scope,$rootScope,$location,$window,$interval,localStorageService,roomService,toastr){$scope.myInterval=5e3,$scope.slideno=0,$scope.noWrapSlides=!1,$scope.active=0;var slides=$scope.slides=[],currIndex=0,piclist=JSON.parse(localStorage.getItem("piclist")),picnamelist=JSON.parse(localStorage.getItem("picnamelist"));if($scope.addSlide=function(pic,picname){600+slides.length+1;slides.push({image:pic,text:picname,id:currIndex++})},0!==piclist.length)for(var i=0;i<piclist.length;i++)$scope.addSlide(piclist[i],picnamelist[i]);else console.log("list is empty");$scope.backToMenu=function(){$location.path("app"),$rootScope.socket.disconnect()},$scope.download=function(){if($scope.slideno>=piclist.length||$scope.slideno<0)return void toastr.error("Please enter a valid slide number!","Oops!");var e,lnk=document.createElement("a");lnk.download="untitled.png",lnk.href=piclist[$scope.slideno],document.createEvent?(e=document.createEvent("MouseEvents"),e.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),lnk.dispatchEvent(e)):lnk.fireEvent&&lnk.fireEvent("onclick")}}),angular.module("yoodle").controller("PlayCtrl",function($scope,$rootScope,$location,$window,$interval,localStorageService,roomService,toastr){$scope.canvas=document.getElementById("canvas"),$scope.ctx=$scope.canvas.getContext("2d"),$rootScope.clearCtx=function(){$scope.ctx.clearRect(0,0,canvas.width,canvas.height)};$scope.canvas.onmousedown=function(e){if($rootScope.isArtist&&$rootScope.gameStarted){var x,y;void 0!==e.offsetX?(x=e.offsetX-30,y=e.offsetY-30):(x=e.layerX-e.currentTarget.offsetLeft,y=e.layerY-event.currentTarget.offsetTop),$rootScope.socket.emit("artistDrawDown",x,y,roomService.getRoomID()),$scope.canvas.onmousemove=function(e){$rootScope.isArtist&&$rootScope.gameStarted&&(void 0!==e.offsetX?(x=e.offsetX-30,y=e.offsetY-30):(x=e.layerX-e.currentTarget.offsetLeft,y=e.layerY-event.currentTarget.offsetTop),$rootScope.socket.emit("artistDrawMove",x,y,roomService.getRoomID()))}}},$scope.canvas.onmouseup=function(e){$rootScope.socket.emit("artistDrawStop",roomService.getRoomID())},$rootScope.socket.on("artistDrawDown",function(x,y,e){$scope.lastX=x,$scope.lastY=y,$scope.ctx.beginPath(),$scope.drawing=!0}),$rootScope.socket.on("artistDraw",function(x,y){$scope.drawing&&($scope.ctx.beginPath(),$scope.currX=x,$scope.currY=y,$scope.ctx.moveTo($scope.lastX,$scope.lastY),$scope.ctx.lineWidth=2,$scope.ctx.lineTo($scope.currX,$scope.currY),$scope.ctx.strokeStyle="#4bf",$scope.ctx.stroke(),$scope.lastX=$scope.currX,$scope.lastY=$scope.currY)}),$rootScope.socket.on("artistDrawStop",function(){$scope.drawing=!1}),$rootScope.socket.on("artistClear",function(){console.log("trying to clear (client)"),$scope.ctx.clearRect(0,0,$scope.canvas.width,$scope.canvas.height)}),$scope.username=localStorageService.get("username"),$scope.roomID=roomService.getRoomID(),roomService.setRoomIDCallback(function(id){$scope.roomID=id}),$scope.playerList=roomService.getPlayerList(),roomService.setPlayerListCallback(function(list){$scope.playerList=list,$scope.$apply()}),$scope.time=0,roomService.setTimerCallback(function(t){0>t?$scope.time=0:$scope.time=t,null!==document.getElementById("bar")&&(document.getElementById("bar").style.width=$scope.time/roomService.getMaxTime()*100+"%",document.getElementById("bar").innerHTML=$scope.time/roomService.getMaxTime()*100+"%")}),$rootScope.socket.on("newWord",function(word){$scope.currentWord=word,$scope.length=$scope.currentWord.length,$scope.ltext="Word Length: "}),$scope.goGallery=function(){$rootScope.socket.emit("leaveRoom",roomService.getRoomID(),$scope.username),$rootScope.socket.emit("clearUsedWordsList"),roomService.cleanup(),$location.path("end")},$scope.backToMenu=function(){$rootScope.socket.emit("leaveRoom",roomService.getRoomID(),$scope.username),roomService.cleanup(),$location.path("app"),$rootScope.socket.disconnect()},$scope.startGame=function(){$rootScope.socket.emit("startGame",roomService.getRoomID()),$rootScope.socket.emit("artistClear",roomService.getRoomID)},$scope.clearCanvas=function(){$scope.ctx.clearRect(0,0,$scope.canvas.width,$scope.canvas.height),console.log("Clear button pressed."),$rootScope.socket.emit("artistClear",roomService.getRoomID)},$scope.saveImage=function(){$scope.image=$scope.canvas.toDataURL("image/png").replace("image/png","image/octet-stream");var e,lnk=document.createElement("a");lnk.download="untitled.png",lnk.href=$scope.image,document.createEvent?(e=document.createEvent("MouseEvents"),e.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),lnk.dispatchEvent(e)):lnk.fireEvent&&lnk.fireEvent("onclick")},$scope.sendGuess=function(){$rootScope.socket.emit("guess",$scope.guess,$scope.username),$scope.guess=""};var lastSkipped=(new Date).getTime();$scope.skipWord=function(){var currTime=(new Date).getTime();$rootScope.isArtist&&currTime-lastSkipped>1e3&&(lastSkipped=currTime,$rootScope.socket.emit("newWord"),$rootScope.socket.emit("skippedWord"),$rootScope.socket.emit("artistClear"))},window.onbeforeunload=function(e){return $rootScope.socket.connected&&$rootScope.socket.emit("leaveRoom",roomService.getRoomID(),$scope.username),!0};var piclist=[],picnamelist=[];localStorage.setItem("piclist",JSON.stringify(piclist)),localStorage.setItem("picnamelist",JSON.stringify(picnamelist));var snd=new Audio("./assets/correct.wav"),snd2=new Audio("./assets/wrong.wav");$rootScope.socket.on("correctGuess",function(name,word){snd.play(),localStorageService.get("username")===name?toastr.success("You guessed it right!","Congrats!"):toastr.success(name+' guessed the word correctly!  It was "'+word+'"',"Correct!"),piclist=JSON.parse(localStorage.getItem("piclist")),piclist.push($scope.canvas.toDataURL()),localStorage.setItem("piclist",JSON.stringify(piclist)),picnamelist=JSON.parse(localStorage.getItem("picnamelist")),picnamelist.push($scope.currentWord),localStorage.setItem("picnamelist",JSON.stringify(picnamelist)),$rootScope.socket.emit("artistClear",roomService.getRoomID)}),$rootScope.socket.on("wrongGuess",function(name,guess){localStorageService.get("username")===name?(toastr.error("You guessed it wrong!","Oops!"),snd2.play()):(toastr.error(name+" guessed ["+guess+"] but it's wrong!","Oops!"),snd2.play())}),$rootScope.socket.on("gameEnd",function(){$scope.goGallery()})}),angular.module("yoodle").directive("drawing",function(){return{restrict:"A",link:function(scope,element){function draw(lX,lY,cX,cY){ctx.moveTo(lX,lY),ctx.lineTo(cX,cY),ctx.strokeStyle="#4bf",ctx.stroke()}var lastX,lastY,ctx=element[0].getContext("2d"),drawing=!1;element.bind("mousedown",function(event){void 0!==event.offsetX?(lastX=event.offsetX-45,lastY=event.offsetY-45):(lastX=event.layerX-event.currentTarget.offsetLeft,lastY=event.layerY-event.currentTarget.offsetTop),ctx.beginPath(),drawing=!0}),element.bind("mousemove",function(event){drawing&&(void 0!==event.offsetX?(currentX=event.offsetX-45,currentY=event.offsetY-45):(currentX=event.layerX-event.currentTarget.offsetLeft,currentY=event.layerY-event.currentTarget.offsetTop),draw(lastX,lastY,currentX,currentY),lastX=currentX,lastY=currentY)}),element.bind("mouseup",function(event){drawing=!1})}}}),angular.module("yoodle").controller("JoinRoomModalCtrl",function($scope,$rootScope,$location,localStorageService,roomService){$scope.submitRoomCode=function(){$scope.roomCode=$scope.roomCode.toUpperCase(),roomService.setRoomID($scope.roomCode),$rootScope.socket.emit("joinRoom",roomService.getRoomID(),localStorageService.get("username")),console.log("Joining "+roomService.getRoomID()+", name "+localStorageService.get("username")),$rootScope.modalInstance.close()}}),angular.module("yoodle").controller("SettingsModalCtrl",function($scope,$rootScope,localStorageService,toastr){$scope.username=localStorageService.get("username"),$scope.serverIP=localStorageService.get("serverIP")||"127.0.0.1",$scope.difficulty=localStorageService.get("difficulty")||"easy",$scope.dismissModal=function(){$rootScope.modalInstance.close()},$scope.saveSettings=function(){$scope.username.length>0?(localStorageService.set("username",$scope.username),localStorageService.set("serverIP",$scope.serverIP),localStorageService.set("difficulty",$scope.difficulty),$rootScope.socket.connected||($rootScope.socket=io("http://"+$scope.serverIP+":3001",{"connect timeout":5e3})),$rootScope.modalInstance.close(),toastr.success("Settings saved!","Success")):toastr.error("Usernames can't be empty","Try again")}}),angular.module("yoodle").factory("roomService",function($interval,$rootScope){var IDCallback,playerList,playerListCallback,time,maxTime,timer,timerCallback,roomID="";return{setRoomIDCallback:function(func){IDCcallback=func},setRoomID:function(id){roomID=id,IDCallback&&IDCallback(roomID)},getRoomID:function(){return roomID},setPlayerListCallback:function(func){playerListCallback=func},setPlayerList:function(players){playerList=players,playerListCallback&&playerListCallback(players)},setTimerCallback:function(func){timerCallback=func},getPlayerList:function(){return playerList},newTimer:function(t){maxTime=t,time=t,$interval.cancel(timer),timer=$interval(function(){time--,0>=time&&$interval.cancel(timer),timerCallback&&timerCallback(time)},1e3)},minusTimer:function(t){time-=t},getMaxTime:function(){return maxTime},cleanup:function(){roomID="",$interval.cancel(timer),$rootScope.gameStarted=!1,$rootScope.isArtist=!1}}});